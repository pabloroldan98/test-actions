# Source: https://coderefinery.github.io/documentation/gh_workflow/ and
#         https://glebbahmutov.com/blog/versioned-doc-pages/

name: Docs
on: push
# Allows you to run this workflow manually from the Actions tab
workflow_dispatch:
jobs:
  docs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      #----------------------------------------------
      #  -----  install & configure poetry  -----
      #----------------------------------------------
      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          virtualenvs-create: true
          virtualenvs-in-project: true
          installer-parallel: true
      - uses: actions/setup-python@v4
        with:
          python-version: 3.8
          cache: 'poetry'
      - name: Save version
        run: |
          POETRY_VERSION=$(poetry version -s)
          echo "RELEASE_VERSION=S{POETRY_VERSION}"
          echo "RELEASE_VERSION=${POETRY_VERSION}" >> $GITHUB_ENV
      - name: Install dependencies
        run: |
          poetry install
      - name: Sphinx build
        run: |
          poetry run sphinx-build docs/source _build
      - name: Deploy version ðŸš€
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          # deploy the current public folder
          # to <base url>/x.y.z version subfolder
          publish_dir: ./_build
          destination_dir: ${{ env.RELEASE_VERSION }}

      - name: Deploy root ðŸš€
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          # deploy the current public folder to <base url>
          publish_dir: ./_build
